name: 03_OpenClaw_Docs_Translate_Docs

on:
  # 监听 temp_for_translation 目录的变更（只监听添加/修改，不包括删除）
  # push:
  #   branches: [ main ]
  #   paths:
  #     - 'temp_for_translation/**'
  workflow_dispatch:  # 允许手动触发

jobs:
  translate-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install requests

    - name: Check if temp_for_translation directory exists and has content
      id: check_content
      run: |
        if [ -d "temp_for_translation" ] && [ -n "$(ls -A temp_for_translation)" ]; then
          echo "has_content=true" >> $GITHUB_OUTPUT
          echo "Temp directory exists and has content"
        else
          echo "has_content=false" >> $GITHUB_OUTPUT
          echo "Temp directory is empty or does not exist"
        fi

    - name: Translate documents using multi-service script
      if: steps.check_content.outputs.has_content == 'true'
      run: |
        python scripts/translate_multi_service.py \
          --source-dir temp_for_translation \
          --target-dir docs \
          --source-lang en \
          --target-lang zh \
          --libretranslate-urls https://libretranslate.de https://translate.argosopentech.com https://fy.iywol.com \
          --libretranslate-tokens https://fy.iywol.com:1234567890 \
          --max-retries 2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Fallback - copy files if translation service unavailable
      if: steps.check_content.outputs.has_content == 'true'
      run: |
        # 如果 docs 目录未创建或为空，复制原始文件作为备用
        if [ ! -d "docs" ] || [ -z "$(ls -A docs)" ]; then
          echo "Translation service unavailable, copying original files as fallback"
          mkdir -p docs
          cp -r temp_for_translation/* docs/ 2>/dev/null || echo "No files to copy"
        fi

    - name: Commit translated documents
      if: steps.check_content.outputs.has_content == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add the docs directory
        git add docs/
        
        # Check if there are changes to commit
        if ! git diff --cached --quiet; then
          git commit -m "Translate: Add translated documents from temp_for_translation to docs [skip ci]"
          git push origin main
          echo "Translated documents committed and pushed"
        else
          echo "No changes to commit"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup temp directory after successful translation
      if: steps.check_content.outputs.has_content == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Remove temp directory
        rm -rf temp_for_translation
        
        # Add, commit and push the removal
        git add -A
        if ! git diff --cached --quiet; then
          git commit -m "Cleanup: Remove temp_for_translation after processing [skip ci]"
          git push origin main
          echo "Temp directory removed and changes pushed"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true  # 避免清理步骤失败影响整体流程