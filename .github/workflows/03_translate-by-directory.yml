name: 03_OpenClaw_Docs_Translate_Docs

on:
  repository_dispatch:
    types: [translate-docs-requested]
  workflow_dispatch:  # 允许手动触发

jobs:
  translate-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install requests

    - name: Check if temp_for_translation directory exists and has markdown files
      id: check_content
      run: |
        if [ -d "temp_for_translation" ] && [ -n "$(find temp_for_translation -name '*.md' -type f 2>/dev/null)" ]; then
          echo "has_content=true" >> $GITHUB_OUTPUT
          MARKDOWN_FILES_COUNT=$(find temp_for_translation -name '*.md' -type f | wc -l)
          echo "Found $MARKDOWN_FILES_COUNT markdown files in temp_for_translation"
        else
          echo "has_content=false" >> $GITHUB_OUTPUT
          echo "No markdown files found in temp_for_translation directory"
        fi

    - name: Translate documents using LLM
      if: steps.check_content.outputs.has_content == 'true'
      run: |
        python scripts/translate_with_llm.py \
          --source-dir temp_for_translation \
          --target-dir docs \
          --source-lang English \
          --target-lang Chinese \
          --provider qwen-portal \
          --qwen-portal-model qwen3-coder-plus \
          --qwen-portal-base-url https://dashscope.aliyuncs.com/compatible-mode/v1 \
          --max-retries 2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        QWEN_PORTAL_API_KEY: ${{ secrets.QWEN_PORTAL_API_KEY }}

    - name: Check translation success
      id: translation_success
      if: steps.check_content.outputs.has_content == 'true'
      run: |
        # 检查翻译是否成功 - 检查temp_for_translation目录是否还有未处理的文件
        # 即使有空子目录，只要没有未处理的文件，也认为翻译成功
        if [ -d "temp_for_translation" ] && [ -n "$(find temp_for_translation -type f -name '*.md' 2>/dev/null)" ]; then
          # temp_for_translation目录中仍有未处理的MD文件，说明有文件未被翻译
          echo "translation_successful=false" >> $GITHUB_OUTPUT
          REMAINING_FILES=$(find temp_for_translation -type f -name '*.md' 2>/dev/null | wc -l)
          echo "Translation incomplete: $REMAINING_FILES markdown files remain in temp_for_translation (some translations failed)"
        else
          # temp_for_translation目录中没有MD文件，说明所有文件都已处理
          if [ -d "docs" ] && [ -n "$(find docs -name '*.md' -type f 2>/dev/null)" ]; then
            echo "translation_successful=true" >> $GITHUB_OUTPUT
            echo "All markdown files appear to have been successfully translated"
          else
            echo "translation_successful=false" >> $GITHUB_OUTPUT
            echo "No markdown files remain in temp_for_translation but docs directory has no Markdown files"
          fi
        fi

    - name: Fallback - copy files if translation service unavailable
      if: steps.check_content.outputs.has_content == 'true' && steps.translation_success.outputs.translation_successful != 'true'
      run: |
        # 如果翻译失败，复制原始文件作为备用，但不更新翻译成功状态
        if [ ! -d "docs" ] || [ -z "$(ls -A docs)" ]; then
          echo "Translation service unavailable, copying original files as fallback"
          mkdir -p docs
          cp -r temp_for_translation/* docs/ 2>/dev/null || echo "No files to copy"
        else
          echo "Docs directory already exists with content"
        fi
      continue-on-error: true

    - name: Commit translated documents
      if: steps.check_content.outputs.has_content == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add the docs directory
        git add docs/
        
        # Check if there are changes to commit
        if ! git diff --cached --quiet; then
          git commit -m "Translate: Add translated documents from temp_for_translation to docs [skip ci]"
          git push origin main
          echo "Translated documents committed and pushed"
        else
          echo "No changes to commit"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup temp directory after successful translation and dispatch event
      if: steps.check_content.outputs.has_content == 'true' && steps.translation_success.outputs.translation_successful == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Remove temp directory only if translation was successful
        rm -rf temp_for_translation
        
        # Add, commit and push the removal
        git add -A
        if ! git diff --cached --quiet; then
          git commit -m "Cleanup: Remove temp_for_translation after successful processing [skip ci]"
          git push origin main
          echo "Temp directory removed and changes pushed"
        fi
        
        # 发送repository dispatch事件来触发04工作流进行质量检查
        curl -X POST \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Content-Type: application/json" \
          https://api.github.com/repos/${{ github.repository }}/dispatches \
          -d '{"event_type":"translation-completed","client_payload":{"trigger_workflow":"03","reason":"Translation process completed"}}'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true  # 避免清理步骤失败影响整体流程

    - name: Log warning if translation failed but temp directory preserved
      if: steps.check_content.outputs.has_content == 'true' && steps.translation_success.outputs.translation_successful == 'false'
      run: |
        echo "WARNING: Translation appears to have failed. Temp directory preserved for debugging."
        echo "Files in temp_for_translation:"
        ls -la temp_for_translation/