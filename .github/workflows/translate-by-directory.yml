name: OpenClaw Docs - Distributed Translation by Directory

on:
  workflow_run:
    workflows: ["OpenClaw Docs - Detect Changes"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      target_directory:
        description: 'Directory to translate (leave empty for all)'
        required: false
        default: ''

jobs:
  translate-if-needed:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install js-yaml

    - name: Check for detected changes
      run: |
        # Create a temporary script to check if there are changes to translate
        cat > check_changes.sh << 'CHK'
#!/bin/bash
# First, run detect_changes.sh to get the latest changes
bash scripts/detect_changes.sh

# Check if there are any files to translate
if [ -f "/tmp/new_or_modified_files.txt" ] && [ -s "/tmp/new_or_modified_files.txt" ]; then
  echo "CHANGES_FOUND=true" >> $GITHUB_ENV
  echo "Number of files to translate: $(cat /tmp/new_or_modified_files.txt | wc -l)"
  cat /tmp/new_or_modified_files.txt > files_to_translate.txt
else
  echo "CHANGES_FOUND=false" >> $GITHUB_ENV
fi
CHK
        chmod +x check_changes.sh
        bash check_changes.sh

    - name: Prepare for targeted translation
      if: env.CHANGES_FOUND == 'true'
      run: |
        # Create necessary directories
        mkdir -p docs_zh
        mkdir -p temp_translation
        
        # Copy only the files that need to be translated
        echo "Processing only changed files..."
        while IFS= read -r file; do
          if [ -n "$file" ] && [ -f "docs/$file" ]; then
            # Create directory structure
            mkdir -p "temp_translation/$(dirname "$file")"
            cp "docs/$file" "temp_translation/$file"
            echo "Added $file for translation"
          fi
        done < files_to_translate.txt

    - name: Perform targeted translation
      if: env.CHANGES_FOUND == 'true'
      run: |
        echo "Translating only changed files..."
        # In a real implementation, this would call the translation API for each file
        # For this example, we'll just copy the files to demonstrate the concept
        if [ -d "temp_translation" ]; then
          # This is where the actual translation would occur
          echo "Processing $(ls temp_translation/**/*.md 2>/dev/null | wc -l) files for translation"
          find temp_translation -name "*.md" -exec echo "Would translate: {}" \;
        fi

    - name: Update navigation configs with localization
      if: env.CHANGES_FOUND == 'true'
      run: |
        # Run the localization script to update navigation configurations
        if [ -f "scripts/localize_nav_config.py" ]; then
          chmod +x scripts/localize_nav_config.py
          python scripts/localize_nav_config.py docs/docs.json docs/docs.json
          python scripts/localize_nav_config.py docs/_config.yml docs/_config.yml
        fi

    - name: Commit and push translated files
      if: env.CHANGES_FOUND == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git fetch origin
        git add docs/ docs/docs.json docs/_config.yml
        git diff --cached --quiet && echo "No changes to commit" || {
          git commit -m "Translation: Update selected documents based on upstream changes [skip ci]"
          git push origin main
          echo "Updated files pushed to repository"
        }
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Report no changes needed
      if: env.CHANGES_FOUND == 'false'
      run: |
        echo "No changes detected, no translation needed"
