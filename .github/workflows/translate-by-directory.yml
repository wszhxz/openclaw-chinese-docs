name: OpenClaw Docs - Distributed Translation by Directory

on:
  workflow_run:
    workflows: ["OpenClaw Docs - Detect Changes"]
    types:
      - completed
  workflow_run:
    workflows: ["OpenClaw Docs - Translation Review"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      target_directory:
        description: 'Directory to translate (leave empty for all)'
        required: false
        default: ''

jobs:
  translate-if-needed:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install js-yaml

    - name: Run translation task manager
      run: |
        # Run the task management script to consolidate all translation needs
        chmod +x scripts/manage-translation-tasks.sh
        bash scripts/manage-translation-tasks.sh

    - name: Check for consolidated translation tasks
      run: |
        # Source the task summary
        if [ -f "temp_translation_tasks/task_summary.env" ]; then
          source temp_translation_tasks/task_summary.env
          echo "TOTAL_TRANSLATION_TASKS=$TOTAL_TRANSLATION_TASKS" >> $GITHUB_ENV
          echo "HAS_TRANSLATION_TASKS=$HAS_TRANSLATION_TASKS" >> $GITHUB_ENV
          echo "FIRST_TRANSLATION_TASK=$FIRST_TRANSLATION_TASK" >> $GITHUB_ENV
        else
          echo "TOTAL_TRANSLATION_TASKS=0" >> $GITHUB_ENV
          echo "HAS_TRANSLATION_TASKS=false" >> $GITHUB_ENV
          echo "FIRST_TRANSLATION_TASK=" >> $GITHUB_ENV
        fi

    - name: Prepare for targeted translation
      if: env.HAS_TRANSLATION_TASKS == 'true'
      run: |
        # Create necessary directories
        mkdir -p docs_zh
        mkdir -p temp_translation
        
        # Copy only the files that need to be translated based on consolidated tasks
        echo "Processing consolidated translation tasks..."
        echo "Total tasks: $TOTAL_TRANSLATION_TASKS"
        
        # Process each file that needs translation
        while IFS= read -r file; do
          if [ -n "$file" ] && [ -f "docs/$file" ]; then
            # Create directory structure
            mkdir -p "temp_translation/$(dirname "$file")"
            cp "docs/$file" "temp_translation/$file"
            echo "Added $file for translation"
          fi
        done < temp_translation_tasks/all_pending_translations.txt

    - name: Perform targeted translation
      if: env.HAS_TRANSLATION_TASKS == 'true'
      run: |
        echo "Translating consolidated files..."
        # In a real implementation, this would call the translation API for each file
        # For this example, we'll just copy the files to demonstrate the concept
        if [ -d "temp_translation" ]; then
          # This is where the actual translation would occur
          echo "Processing $(find temp_translation -name "*.md" | wc -l) files for translation"
          find temp_translation -name "*.md" -exec echo "Would translate: {}" \;
        fi

    - name: Update navigation configs with localization
      if: env.HAS_TRANSLATION_TASKS == 'true'
      run: |
        # Run the localization script to update navigation configurations
        if [ -f "scripts/localize_nav_config.py" ]; then
          chmod +x scripts/localize_nav_config.py
          python scripts/localize_nav_config.py docs/docs.json docs/docs.json
          python scripts/localize_nav_config.py docs/_config.yml docs/_config.yml
        fi

    - name: Commit and push translated files
      if: env.HAS_TRANSLATION_TASKS == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git fetch origin
        git add docs/ docs/docs.json docs/_config.yml
        git diff --cached --quiet && echo "No changes to commit" || {
          git commit -m "Translation: Update documents based on consolidated translation tasks [skip ci]"
          git push origin main
          echo "Updated files pushed to repository"
        }
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Report no changes needed
      if: env.HAS_TRANSLATION_TASKS == 'false'
      run: |
        echo "No translation tasks found, no translation needed"
