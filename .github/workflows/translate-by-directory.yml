name: OpenClaw Docs - Distributed Translation by Directory

on:
  workflow_run:
    workflows: ["OpenClaw Docs - Detect Changes"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      target_directory:
        description: 'Directory to translate (leave empty for all)'
        required: false
        default: ''

jobs:
  translate-if-needed:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 2

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install js-yaml

    - name: Check if translation is needed (manual trigger)
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "MANUAL_TRANSLATION=true" >> $GITHUB_ENV
        if [ -n "${{ github.event.inputs.target_directory }}" ]; then
          echo "TARGET_DIRECTORY=${{ github.event.inputs.target_directory }}" >> $GITHUB_ENV
        fi

    - name: Check if translation is needed (scheduled)
      if: github.event_name == 'workflow_run'
      run: |
        # Download artifacts from the detect-changes workflow
        # For now, we'll use a simplified approach
        echo "MANUAL_TRANSLATION=false" >> $GITHUB_ENV

    - name: Prepare for translation
      run: |
        # Create necessary directories
        mkdir -p docs_zh
        mkdir -p temp_translation

        # If triggered manually with a specific directory
        if [ "$MANUAL_TRANSLATION" = "true" ]; then
          if [ -n "$TARGET_DIRECTORY" ]; then
            echo "Processing specific directory: $TARGET_DIRECTORY"
            mkdir -p temp_translation
            find docs -path "*/$TARGET_DIRECTORY/*" -name "*.md" -exec cp --parents {} temp_translation/ \; 2>/dev/null || echo "No files found in directory $TARGET_DIRECTORY"
          else
            echo "Processing all changed files"
            # This would normally come from the detect-changes workflow
            # For now we'll just set a flag to continue
            touch temp_translation/all_files
          fi
        else
          # This would come from the detect-changes workflow
          echo "Checking for changes detected by scheduled workflow"
          # We'll implement the actual integration in a real scenario
          touch temp_translation/all_files
        fi

    - name: Perform translation
      run: |
        if [ -f temp_translation/all_files ]; then
          echo "Translating all changed files..."
          # Create a script to process all markdown files in docs/
          cat > translate_batch.js << 'EOF'
const fs = require('fs');
const path = require('path');

/**
 * Batch translation script
 * Processes all markdown files in the docs directory
 * Preserves existing Chinese translations
 */
async function translateBatch() {
    const docsDir = 'docs';
    const outputDir = 'docs_zh';
    
    // Ensure output directory exists
    if (!fs.existsSync(outputDir)) {
        fs.mkdirSync(outputDir, { recursive: true });
    }
    
    // Find all markdown files
    const findMdFiles = (dir) => {
        let results = [];
        const items = fs.readdirSync(dir);
        
        for (const item of items) {
            const fullPath = path.join(dir, item);
            const stat = fs.statSync(fullPath);
            
            if (stat.isDirectory()) {
                results = results.concat(findMdFiles(fullPath));
            } else if (item.endsWith('.md')) {
                results.push(fullPath);
            }
        }
        
        return results;
    };
    
    const mdFiles = findMdFiles(docsDir);
    console.log(`Found ${mdFiles.length} markdown files to process`);
    
    for (const file of mdFiles) {
        try {
            // Calculate output path
            const relativePath = path.relative(docsDir, file);
            const outputPath = path.join(outputDir, relativePath);
            
            // Ensure output directory exists
            const outputDirPath = path.dirname(outputPath);
            if (!fs.existsSync(outputDirPath)) {
                fs.mkdirSync(outputDirPath, { recursive: true });
            }
            
            // Check if there's already a Chinese translation for this file
            const existingTranslationPath = path.join(outputDir, relativePath);
            if (fs.existsSync(existingTranslationPath)) {
                // Check if the existing translation is actually in Chinese
                const existingContent = fs.readFileSync(existingTranslationPath, 'utf8');
                if (existingContent.includes('中文') || existingContent.includes('翻译') || 
                    existingContent.includes('Chinese') || existingContent.toLowerCase().includes('chinese')) {
                    console.log(`Skipping ${relativePath}, already has Chinese translation`);
                    continue; // Skip if already translated to Chinese
                }
            }
            
            // Read the file
            let content = fs.readFileSync(file, 'utf8');
            
            // Preserve frontmatter
            const lines = content.split('\n');
            let frontmatter = '';
            let body = content;
            
            if (lines[0] === '---') {
                let frontmatterEnd = -1;
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i] === '---' && frontmatterEnd === -1) {
                        frontmatterEnd = i;
                        break;
                    }
                }
                
                if (frontmatterEnd > 0) {
                    frontmatter = lines.slice(0, frontmatterEnd + 1).join('\n');
                    body = lines.slice(frontmatterEnd + 1).join('\n');
                }
            }
            
            // For this implementation, we'll just add a marker
            // In a real implementation, this would call a translation API
            const translatedBody = body; // Placeholder for actual translation
            
            // Write the translated file
            fs.writeFileSync(outputPath, frontmatter + (frontmatter ? '\n' : '') + translatedBody);
            console.log(`Processed: ${relativePath}`);
            
            // Simulate processing delay
            await new Promise(resolve => setTimeout(resolve, 100));
        } catch (error) {
            console.error(`Error processing ${file}:`, error.message);
        }
    }
    
    console.log('Batch translation completed');
}

translateBatch().catch(console.error);
EOF
            node translate_batch.js
        else
            echo "Processing specific directory..."
            # Implementation for specific directory translation
            # In a real scenario, this would translate only files in the specified directory
            echo "Directory translation feature would be implemented here"
        fi

    - name: Update navigation configs with localization
      run: |
        # Run the localization script to update navigation configurations
        chmod +x scripts/localize_nav_config.py
        python scripts/localize_nav_config.py docs/docs.json docs/docs.json
        python scripts/localize_nav_config.py docs/_config.yml docs/_config.yml

    - name: Commit and push translated files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git fetch origin
        git add docs_zh/ docs/docs.json docs/_config.yml
        git diff --cached --quiet && echo "No changes to commit" || {
          git commit -m "Translation: Update translated documents and navigation [skip ci]"
          git push
          echo "Translated files and navigation configs pushed to repository"
        }
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}