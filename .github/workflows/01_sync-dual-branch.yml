name: 01_OpenClaw_Sync_Original_Branch_And_Prepare_Translations

on:
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨2点运行一次
  workflow_dispatch:  # 允许手动触发

jobs:
  sync-and-prepare-translations:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Create backup commit for rollback
      run: |
        # 创建一个备份提交，以便在出错时可以恢复
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        # 记录当前HEAD作为备份点
        BACKUP_COMMIT=$(git rev-parse HEAD)
        echo "BACKUP_COMMIT=$BACKUP_COMMIT" >> $GITHUB_ENV
        echo "Created backup at commit: $BACKUP_COMMIT"

    - name: Clone original OpenClaw project
      run: |
        git clone --depth 1 https://github.com/openclaw/openclaw.git temp-original-openclaw

    - name: Compare and process changes before sync
      id: compare-and-process
      run: |
        echo "Comparing original-en branch with source project and processing changes..."
        
        # 获取 original-en 分支的最新内容（用于对比）
        git fetch origin
        git worktree add temp-worktree-original-en original-en
        
        # 创建临时文件存储需要处理的文件
        > /tmp/new_or_updated_docs.txt
        > /tmp/deleted_docs.txt
        
        # 确保临时翻译目录存在
        mkdir -p temp_for_translation/docs
        
        # 获取原始项目中的所有文档路径
        ORIGINAL_DOC_PATHS=$(find temp-original-openclaw/docs -name "*.md" -type f | sed 's|temp-original-openclaw/docs/||')
        
        # 对比源项目与original-en分支，找出新增或修改的文档
        for orig_path in $ORIGINAL_DOC_PATHS; do
          orig_doc="temp-original-openclaw/docs/$orig_path"
          original_en_doc="temp-worktree-original-en/docs/$orig_path"
          
          # 检查是否是新文件或内容已更新（与original-en分支相比）
          if [ ! -f "$original_en_doc" ] || ! cmp -s "$orig_doc" "$original_en_doc"; then
            # 这是一个新文件或已更新的文件，需要翻译
            echo "$orig_path" >> /tmp/new_or_updated_docs.txt
            # 确保目录存在并复制到临时翻译目录
            mkdir -p "$(dirname "temp_for_translation/docs/$orig_path")"
            cp "$orig_doc" "temp_for_translation/docs/$orig_path"
            if [ ! -f "$original_en_doc" ]; then
              echo "Found new doc for translation: $orig_path"
            else
              echo "Found updated doc for retranslation: $orig_path"
            fi
          fi
        done
        
        # 检查是否有已删除的文档（在original-en分支中存在但在源项目中不存在）
        for original_en_doc in $(find temp-worktree-original-en/docs -name "*.md" -type f); do
          relative_path=${original_en_doc#temp-worktree-original-en/docs/}
          orig_doc="temp-original-openclaw/docs/$relative_path"
          
          if [ ! -f "$orig_doc" ]; then
            # 文档在原始项目中已删除，记录到删除列表
            echo "$relative_path" >> /tmp/deleted_docs.txt
            echo "Found deleted doc in original project: $relative_path"
          fi
        done
        
        # 统计需要处理的文件数量
        TOTAL_NEW_OR_UPDATED=$(cat /tmp/new_or_updated_docs.txt | wc -l)
        TOTAL_DELETED=$(cat /tmp/deleted_docs.txt | wc -l)
        
        echo "Changes detected: New/Updated=$TOTAL_NEW_OR_UPDATED, Deleted=$TOTAL_DELETED"
        
        # 只有在有删除操作时才处理删除（先处理变化）
        if [ $TOTAL_DELETED -gt 0 ]; then
          echo "Processing deleted docs from original project..."
          
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 逐个删除对应的中文文档
          while IFS= read -r deleted_doc; do
            if [ -n "$deleted_doc" ]; then
              doc_path="docs/$deleted_doc"
              if [ -f "$doc_path" ]; then
                echo "Deleting $doc_path"
                rm "$doc_path"
                
                # 删除父目录如果为空
                parent_dir=$(dirname "$doc_path")
                while [ "$parent_dir" != "docs" ]; do
                  if [ -d "$parent_dir" ] && [ -z "$(ls -A "$parent_dir")" ]; then
                    echo "Removing empty directory: $parent_dir"
                    rmdir "$parent_dir"
                    parent_dir=$(dirname "$parent_dir")
                  else
                    break
                  fi
                done
              fi
            fi
          done < /tmp/deleted_docs.txt
          
          # 提交删除操作
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "Remove: Delete docs that were removed from original project [skip ci]"
            git push origin main
            echo "Deleted docs removed from main branch"
          else
            echo "No docs to delete"
          fi
        else
          echo "No docs to delete"
        fi
        
        # 同步源项目到 original-en 分支（后同步）
        echo "Syncing source project to original-en branch..."
        cd temp-worktree-original-en
        rsync -av --delete ../temp-original-openclaw/docs/ ./docs/
        
        # 提交到 original-en 分支
        git add .
        if ! git diff --cached --quiet; then
          git config user.name 'github-actions[bot]'
          git config.user.email 'github-actions[bot]@users.noreply.github.com'
          git commit -m "Sync: Update original-en branch with latest from upstream [skip ci]"
          git push origin original-en
          echo "original-en branch updated"
        else
          echo "No changes to original-en branch"
        fi
        cd ..
        
        if [ $TOTAL_NEW_OR_UPDATED -gt 0 ]; then
          echo "Found $TOTAL_NEW_OR_UPDATED files needing translation"
          echo "Files prepared in temp_for_translation directory"
        else
          echo "No files need translation"
        fi

    - name: Commit new docs to temp translation directory if there are translation tasks
      run: |
        # 设置git配置
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # 检查是否有需要翻译的文件
        if [ -d "temp_for_translation/docs" ] && [ -n "$(ls -A temp_for_translation/docs)" ]; then
          # 添加临时翻译目录
          git add temp_for_translation/
          
          # 检查是否有更改
          if ! git diff --cached --quiet; then
            git commit -m "Prepare: Add new or updated docs from original project for translation [skip ci]"
            git push origin main
            echo "New or updated docs committed to temp_for_translation directory"
          else
            echo "No changes to commit"
          fi
        else
          echo "No new or updated docs to translate"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload detected new files as artifact
      uses: actions/upload-artifact@v4
      if: ${{ env.TRANSLATION_TASKS_COUNT > 0 }}
      with:
        name: new-docs-to-translate
        path: /tmp/new_or_updated_docs.txt
        retention-days: 1

    - name: Upload updated files as artifact
      uses: actions/upload-artifact@v4
      if: ${{ env.TRANSLATION_TASKS_COUNT > 0 }}
      with:
        name: updated-docs-to-translate
        path: /tmp/updated_docs_to_translate.txt
        retention-days: 1

    - name: Cleanup worktree
      if: always()
      run: |
        if [ -d "temp-worktree-original-en" ]; then
          git worktree remove temp-worktree-original-en
        fi

    - name: Error recovery (if needed)
      if: failure()
      run: |
        if [ -n "${{ env.BACKUP_COMMIT }}" ]; then
          echo "Reverting to backup commit: ${{ env.BACKUP_COMMIT }}"
          git fetch origin
          git checkout main
          git reset --hard "${{ env.BACKUP_COMMIT }}"
          git push --force origin main
          # 尝试恢复 original-en 分支
          if git rev-parse origin/original-en >/dev/null 2>&1; then
            git checkout original-en
            git reset --hard origin/original-en
            git push --force origin original-en
          fi
          echo "Reverted to backup commit due to error"
        fi

    - name: Cleanup temporary directory
      run: |
        rm -rf temp-original-openclaw