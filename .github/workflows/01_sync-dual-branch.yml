name: 01_OpenClaw_Compare_Docs_Directories

on:
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨2点运行一次
  workflow_dispatch:  # 允许手动触发

jobs:
  compare-docs-directories:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Clone original OpenClaw project
      run: |
        git clone --depth 1 https://github.com/openclaw/openclaw.git temp-original-openclaw

    - name: Compare docs directories and copy differences
      run: |
        echo "Comparing docs directories..."
        
        # 创建临时文件存储需要更新的文件
        > /tmp/new_docs_to_translate.txt
        > /tmp/updated_docs_to_translate.txt
        
        # 检查原始项目中是否有新的markdown文件
        ORIGINAL_DOCS=$(find temp-original-openclaw/docs -name "*.md" -type f)
        
        for orig_doc in $ORIGINAL_DOCS; do
          relative_path=${orig_doc#temp-original-openclaw/docs/}
          target_doc="docs/$relative_path"
          
          # 检查是否是新文件（在我们的docs目录中不存在）
          if [ ! -f "$target_doc" ]; then
            # 这是一个新文件，需要翻译
            echo "$relative_path" >> /tmp/new_docs_to_translate.txt
            # 确保目录存在
            mkdir -p "$(dirname "temp_for_translation/docs/$relative_path")"
            cp "$orig_doc" "temp_for_translation/docs/$relative_path"
            echo "Found new doc: $relative_path"
          else
            # 文件存在，检查内容是否不同
            if ! cmp -s "$orig_doc" "$target_doc"; then
              # 内容不同，需要更新翻译
              echo "$relative_path" >> /tmp/updated_docs_to_translate.txt
              # 确保目录存在
              mkdir -p "$(dirname "temp_for_translation/docs/$relative_path")"
              cp "$orig_doc" "temp_for_translation/docs/$relative_path"
              echo "Found updated doc: $relative_path"
            fi
          fi
        done
        
        # 统计需要翻译的文件数量
        NEW_COUNT=$(cat /tmp/new_docs_to_translate.txt | wc -l)
        UPDATED_COUNT=$(cat /tmp/updated_docs_to_translate.txt | wc -l)
        TOTAL_COUNT=$((NEW_COUNT + UPDATED_COUNT))
        
        echo "New docs to translate: $NEW_COUNT"
        echo "Updated docs to translate: $UPDATED_COUNT"
        echo "Total docs to translate: $TOTAL_COUNT"

    - name: Commit changes to temp directory if there are differences
      run: |
        # 设置git配置
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # 检查是否有需要翻译的文件
        if [ -d "temp_for_translation/docs" ] && [ -n "$(ls -A temp_for_translation/docs)" ]; then
          # 添加临时翻译目录
          git add temp_for_translation/
          
          # 检查是否有更改
          if ! git diff --cached --quiet; then
            git commit -m "feat: Add new or updated docs from original project for translation [skip ci]"
            git push origin main
            echo "New or updated docs committed to temp_for_translation directory"
          else
            echo "No changes to commit"
          fi
        else
          echo "No new or updated docs to translate"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup temporary directory
      run: |
        rm -rf temp-original-openclaw
