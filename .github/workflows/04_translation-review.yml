name: 04_OpenClaw_Docs_Review_Translations

on:
  workflow_run:
    workflows: ["03_OpenClaw_Docs_Translate_Docs"]
    types: [completed]
  workflow_dispatch:  # 允许手动触发

jobs:
  translation-review:
    runs-on: ubuntu-latest
    outputs:
      has_updates_needed: ${{ steps.review.outputs.has_updates_needed }}
      has_untranslated: ${{ steps.review.outputs.has_untranslated }}
      updates_file: ${{ steps.review.outputs.updates_file }}
      untranslated_files_count: ${{ steps.review.outputs.untranslated_files_count }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install js-yaml

    - name: Review translation quality on main branch
      id: review
      run: |
        echo "开始翻译审查..."
        
        # 创建临时文件存储审查结果
        > /tmp/translation_review_results.txt
        > /tmp/translation_quality_issues.txt
        > /tmp/translations_needing_update.txt
        > /tmp/untranslated_files.txt
        > /tmp/files_needing_retranslation.txt
        
        # 检查 main 分支上的中文文档，仅基于文件内容特征进行审查
        if [ -d "docs" ]; then
          find docs -name "*.md" -type f | while read file; do
            relative_path=${file#docs/}
            
            # 检查是否包含中文字符（判断是否已被翻译）
            if grep -q '[一-龯]' "$file" || grep -q '[äöü]' "$file" || grep -q '中文\|翻译\|Chinese' "$file"; then
              echo "$relative_path - 已翻译" >> /tmp/translation_review_results.txt
            else
              # 文件存在但未翻译
              echo "$relative_path - 未翻译" >> /tmp/translation_quality_issues.txt
              echo "$relative_path" >> /tmp/untranslated_files.txt
            fi
          done
        else
          echo "docs目录不存在"
        fi
        
        # 检查是否有任何翻译质量问题
        UNTRANSLATED_COUNT=$(cat /tmp/untranslated_files.txt | wc -l)
        echo "未翻译的文件数: $UNTRANSLATED_COUNT"
        
        if [ "$UNTRANSLATED_COUNT" -gt 0 ]; then
          echo "has_untranslated=true" >> $GITHUB_OUTPUT
          echo "untranslated_files_count=$UNTRANSLATED_COUNT" >> $GITHUB_OUTPUT
          # 假设有需要更新的情况
          echo "has_updates_needed=true" >> $GITHUB_OUTPUT
          FIRST_UNTRANSLATED=$(head -n 1 /tmp/untranslated_files.txt)
          echo "updates_file=$FIRST_UNTRANSLATED" >> $GITHUB_OUTPUT
        else
          echo "has_untranslated=false" >> $GITHUB_OUTPUT
          echo "untranslated_files_count=0" >> $GITHUB_OUTPUT
          echo "has_updates_needed=false" >> $GITHUB_OUTPUT
          echo "updates_file=" >> $GITHUB_OUTPUT
        fi
        
        echo "翻译审查完成"
        TOTAL_TRANSLATED=$(cat /tmp/translation_review_results.txt | wc -l)
        TOTAL_UNTRANSLATED=$(cat /tmp/translation_quality_issues.txt | wc -l)
        TOTAL_UPDATES_NEEDED=$(cat /tmp/translations_needing_update.txt | wc -l)
        TOTAL_ALL=$(($TOTAL_TRANSLATED + $TOTAL_UNTRANSLATED))
        
        # 添加除零检查
        if [ $TOTAL_ALL -eq 0 ]; then
          PERCENTAGE=0
        else
          PERCENTAGE=$((TOTAL_TRANSLATED * 100 / TOTAL_ALL))
        fi
        
        echo "已翻译: $TOTAL_TRANSLATED, 未翻译: $TOTAL_UNTRANSLATED, 需更新: $TOTAL_UPDATES_NEEDED, 总计: $TOTAL_ALL, 完成度: $PERCENTAGE%"

    - name: Generate detailed analysis report
      run: |
        # 输出详细分析结果，不创建任何文件副本
        echo "Translation Review Analysis:"
        echo "---------------------------"
        
        if [ -f /tmp/untranslated_files.txt ] && [ -s /tmp/untranslated_files.txt ]; then
          echo "Untranslated files found:"
          cat /tmp/untranslated_files.txt
        else
          echo "No untranslated files found."
        fi
        
        echo ""
        
        if [ -f /tmp/translations_needing_update.txt ] && [ -s /tmp/translations_needing_update.txt ]; then
          echo "Files needing translation updates:"
          cat /tmp/translations_needing_update.txt
        else
          echo "No files needing translation updates."
        fi

    - name: Generate translation report
      run: |
        TOTAL_TRANSLATED=$(cat /tmp/translation_review_results.txt | wc -l)
        TOTAL_UNTRANSLATED=$(cat /tmp/translation_quality_issues.txt | wc -l)
        TOTAL_UPDATES_NEEDED=$(cat /tmp/translations_needing_update.txt | wc -l)
        TOTAL_ALL=$(($TOTAL_TRANSLATED + $TOTAL_UNTRANSLATED))
        
        if [ $TOTAL_ALL -eq 0 ]; then
          PERCENTAGE=0
        else
          PERCENTAGE=$((TOTAL_TRANSLATED * 100 / TOTAL_ALL))
        fi
        
        cat > translation_review_report.md << REPORT
# 翻译审查报告

生成时间: $(date)

## 统计信息
- 总文件数: $TOTAL_ALL
- 已翻译文件数量: $TOTAL_TRANSLATED
- 未翻译文件数量: $TOTAL_UNTRANSLATED
- 需要更新翻译的文件数量: $TOTAL_UPDATES_NEEDED
- 翻译完成度: $PERCENTAGE%

## 未翻译的文件
$(if [ -f /tmp/untranslated_files.txt ]; then cat /tmp/untranslated_files.txt; else echo "无"; fi)

## 需要更新翻译的文件
$(if [ -f /tmp/translations_needing_update.txt ]; then cat /tmp/translations_needing_update.txt; else echo "无"; fi)

REPORT

    - name: Upload files needing updates as artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: review-needs-update
        path: /tmp/translations_needing_update.txt
        retention-days: 1

    - name: Upload untranslated files as artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: untranslated-files
        path: /tmp/untranslated_files.txt
        retention-days: 1

    - name: Upload review summary as artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: review-summary
        path: translation_review_report.md
        retention-days: 1

    - name: Cleanup temp directory
      run: |
        rm -rf temp-original-openclaw
        rm -f /tmp/translation_review_results.txt
        rm -f /tmp/translation_quality_issues.txt
        rm -f /tmp/translations_needing_update.txt
        rm -f /tmp/untranslated_files.txt
        rm -f /tmp/files_needing_retranslation.txt
        git worktree remove temp-original-en 2>/dev/null || true
        rm -rf ./to-be-translated

  trigger-translation-update-if-needed:
    needs: translation-review
    if: needs.translation-review.outputs.has_updates_needed == 'true' || needs.translation-review.outputs.has_untranslated == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Repository Dispatch - Trigger Translation Update
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: translation-update-requested
          client-payload: '{"review_result": "updates_needed", "trigger_file": "${{ needs.translation-review.outputs.updates_file }}", "untranslated_count": "${{ needs.translation-review.outputs.untranslated_files_count }}" }'
