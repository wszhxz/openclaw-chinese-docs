name: OpenClaw Docs - Full Pipeline

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 * * * *'  # 每小时检查一次
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of files to process per batch (default: 5)'
        required: false
        default: '5'
      force_run:
        description: 'Force run even if no changes detected'
        required: false
        type: boolean
        default: false

# 防止并发运行同一工作流
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  translate-docs:
    runs-on: ubuntu-latest
    
    outputs:
      updates_available: ${{ steps.check_changes.outputs.updates_available }}
      total_changes: ${{ steps.check_changes.outputs.total_changes }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 2  # 获取最近两次提交以进行比较
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm install js-yaml
        pwd
        ls -la
        
    - name: Debug - Check current directory and files
      run: |
        pwd
        ls -la
        ls -la docs_zh/ || echo "docs_zh directory does not exist yet"
        ls -la openclaw-temp/ || echo "openclaw-temp directory does not exist yet"
        
    - name: Fetch latest OpenClaw docs
      run: |
        # 克隆最新的 OpenClaw 仓库
        if [ -d "openclaw-temp" ]; then
          rm -rf openclaw-temp
        fi
        git clone --depth 1 https://github.com/openclaw/openclaw.git openclaw-temp
        echo "Cloned OpenClaw repository"
        echo "Checking cloned files:"
        find openclaw-temp/docs -name "*.md" | head -10
        
    - name: Compare and identify changed files
      id: check_changes
      run: |
        # 检查上次运行后是否有更新
        if [ -d "docs_original" ]; then
          # 创建临时目录
          mkdir -p temp_comparison
          
          # 复制现有原始文档和新文档到临时目录进行比较
          cp -r docs_original/* temp_comparison/original/ 2>/dev/null || true
          cp -r openclaw-temp/docs/* temp_comparison/new/ 2>/dev/null || true
          
          # 检查文件差异
          CHANGES=$(diff -rq temp_comparison/original/ temp_comparison/new/ 2>&1 | grep -E "(differ|Only in temp_comparison/new)" | grep "\.md" | head -n 50 || true)
          
          if [ -n "$CHANGES" ]; then
            echo "Changes detected"
            # 提取变更的文件名
            echo "$CHANGES" | grep -oE "temp_comparison/new/[a-zA-Z0-9/_\-\.]+\.md" | sed 's/temp_comparison\/new\///' > changed_files.txt
            echo "UPDATES_AVAILABLE=true" >> $GITHUB_ENV
            echo "updates_available=true" >> $GITHUB_OUTPUT
          else
            echo "No changes detected"
            echo "UPDATES_AVAILABLE=false" >> $GITHUB_ENV
            echo "updates_available=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "First run - initializing with all files"
          # 第一次运行，获取所有文件
          find openclaw-temp/docs -name "*.md" | sed 's|openclaw-temp/docs/||' > changed_files.txt
          echo "UPDATES_AVAILABLE=true" >> $GITHUB_ENV
          echo "updates_available=true" >> $GITHUB_OUTPUT
        fi
        
        # 统计变更文件数量
        if [ -f changed_files.txt ] && [ -s changed_files.txt ]; then
          COUNT=$(wc -l < changed_files.txt)
          echo "TOTAL_CHANGES=$COUNT" >> $GITHUB_ENV
          echo "total_changes=$COUNT" >> $GITHUB_OUTPUT
          echo "Processing $COUNT files..."
        else
          echo "UPDATES_AVAILABLE=false" >> $GITHUB_ENV
          echo "total_changes=0" >> $GITHUB_OUTPUT
          echo "No files to process."
        fi
    
    - name: Update original docs
      if: env.UPDATES_AVAILABLE == 'true'
      run: |
        # 更新原始文档副本
        rm -rf docs_original
        cp -r openclaw-temp/docs docs_original
        
    - name: Process changed files with translation
      if: env.UPDATES_AVAILABLE == 'true'
      run: |
        # 创建输出目录
        mkdir -p docs_zh
        
        # 读取变更的文件列表
        if [ -f changed_files.txt ]; then
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "openclaw-temp/docs/$file" ]; then
              echo "Processing: $file"
              
              # 创建目标目录结构
              mkdir -p "docs_zh/$(dirname "$file")"
              
              # 运行翻译脚本处理单个文件
              node scripts/process-file.js "openclaw-temp/docs/$file" "docs_zh/$file"
            fi
          done < changed_files.txt
        else
          echo "No files to process"
        fi
        
        # 复制翻译后的文档到网站目录
        if [ -d docs_zh ]; then
          mkdir -p docs
          rsync -av --ignore-existing docs_zh/ docs/
        fi
        
  build-and-deploy:
    runs-on: ubuntu-latest
    needs: translate-docs
    if: needs.translate-docs.outputs.updates_available == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1  # 只需要最新提交
        
    - name: Setup Ruby and Jekyll
      uses: actions/setup-ruby@v1
      with:
        ruby-version: '3.0'
        
    - name: Install Jekyll and dependencies
      run: |
        gem install bundler
        bundle install
        
    - name: Setup Jekyll
      uses: actions/configure-pages@v4
      continue-on-error: true
      
    - name: Build with Jekyll
      uses: actions/jekyll-build-pages@v1
      continue-on-error: true
      with:
        source: ./
        destination: ./_site
        
    - name: Upload site artifact
      uses: actions/upload-pages-artifact@v4
      with:
        path: "_site/"
        
    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4