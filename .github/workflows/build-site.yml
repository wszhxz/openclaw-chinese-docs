name: Phase 2 - Build and Deploy Site

on:
  # 可以手动触发
  workflow_dispatch:
  # 或者通过第一阶段工作流触发
  repository_dispatch:
    types: [build-site-request]
  # 或者定期检查是否需要构建
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨2点检查一次

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # 只有在有中文文档时才运行
    if: ${{ github.event_name == 'workflow_dispatch' || 
           github.event.action == 'build-site-request' ||
           github.event_name == 'schedule' }}
           
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1  # 只需要最新提交
        
    - name: Check if Chinese docs exist
      id: check_docs
      run: |
        if [ -d "docs_zh" ] && [ -n "$(find docs_zh -name '*.md' -print -quit 2>/dev/null)" ]; then
          echo "Chinese docs found, proceeding with build"
          echo "HAS_DOCS=true" >> $GITHUB_ENV
        else
          echo "No Chinese docs found, skipping build"
          echo "HAS_DOCS=false" >> $GITHUB_ENV
        fi
    
    - name: Merge docs to main docs directory
      if: env.HAS_DOCS == 'true'
      run: |
        # 确保主docs目录存在
        mkdir -p docs
        
        # 将中文文档合并到主docs目录
        if [ -d "docs_zh" ]; then
          rsync -av docs_zh/ docs/
          echo "Chinese docs merged to main docs directory"
        fi
        
    - name: Setup Ruby and Jekyll
      if: env.HAS_DOCS == 'true'
      uses: actions/setup-ruby@v1
      with:
        ruby-version: '3.0'
        
    - name: Install Jekyll and dependencies
      if: env.HAS_DOCS == 'true'
      run: |
        gem install bundler
        bundle install
        
    - name: Setup Jekyll
      if: env.HAS_DOCS == 'true'
      uses: actions/configure-pages@v4
      continue-on-error: true
      
    - name: Build with Jekyll
      if: env.HAS_DOCS == 'true'
      uses: actions/jekyll-build-pages@v1
      continue-on-error: true
      with:
        source: ./
        destination: ./_site
        
    - name: Upload site artifact
      if: env.HAS_DOCS == 'true'
      uses: actions/upload-pages-artifact@v4
      with:
        path: "_site/"
        
    - name: Deploy to GitHub Pages
      if: env.HAS_DOCS == 'true'
      uses: actions/deploy-pages@v4

    - name: Report completion
      run: |
        if [ "${{ env.HAS_DOCS }}" = "true" ]; then
          echo "Site built and deployed successfully"
        else
          echo "No docs to build, workflow skipped"
        fi