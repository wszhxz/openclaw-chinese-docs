---
summary: "Voice wake and push-to-talk modes plus routing details in the mac app"
read_when:
  - Working on voice wake or PTT pathways
title: "Voice Wake"
---
# 语音唤醒与按住说话

## 模式

- **唤醒词模式**（默认）：始终开启的语音识别器等待触发词（`swabbleTriggerWords`）。匹配后开始录音，显示带有部分文本的覆盖层，并在静音后自动发送。
- **按住说话**（右选项键按住）：按住右选项键即可立即开始录音，无需触发词。按住时显示覆盖层；释放后经过短延迟才完成并发送，以便您调整文本。

## 运行时行为（唤醒词）

- 语音识别器位于 `VoiceWakeRuntime`。
- 触发仅在唤醒词与下一个词之间有**有意义的停顿**（约0.55秒间隔）时发生。即使命令尚未开始，覆盖层/提示音也可在停顿时启动。
- 静音窗口：语音流畅时为2.0秒，仅听到触发词时为5.0秒。
- 强制停止：120秒以防止会话失控。
- 会话之间去抖动：350毫秒。
- 覆盖层通过 `VoiceWakeOverlayController` 驱动，使用已提交/易变颜色。
- 发送后，识别器会干净重启，以监听下一个触发词。

## 生命周期不变量

- 如果启用了语音唤醒且已授予权限，唤醒词识别器应始终处于监听状态（除非在显式按住说话录音期间）。
- 覆盖层可见性（包括通过X按钮手动关闭）绝不能阻止识别器恢复运行。

## 粘性覆盖层故障模式（先前）

先前，如果覆盖层卡在可见状态且您手动关闭了它，语音唤醒可能看起来“已死”，因为运行时的重启尝试可能被覆盖层可见性阻断，且未安排后续重启。

强化措施：

- 唤醒运行时重启不再受覆盖层可见性阻断。
- 覆盖层关闭完成会通过 `VoiceSessionCoordinator` 触发 `VoiceWakeRuntime.refresh(...)`，因此手动X关闭始终会恢复监听。

## 按住说话具体细节

- 快捷键检测使用全局 `.flagsChanged` 监视器，用于**右选项键**（`keyCode 61` + `.option`）。我们仅观察事件（不吞吃）。
- 录音管道位于 `VoicePushToTalk`：立即开始语音，将部分文本流式传输到覆盖层，并在释放时调用 `VoiceWakeForwarder`。
- 当按住说话开始时，我们暂停唤醒词运行时以避免音频监听冲突；在释放后自动重启。
- 权限：需要麦克风 + 语音；查看事件需要辅助功能/输入监控批准。
- 外部键盘：某些键盘可能未按预期暴露右选项键——如果用户报告遗漏，请提供备用快捷键。

## 用户可见设置

- **语音唤醒**开关：启用唤醒词运行时。
- **按住 Cmd+Fn 说话**：启用按住说话监控。在 macOS < 26 上禁用。
- 语言 & 麦克风选择器、实时音量表、触发词表、测试器（仅本地；不转发）。
- 麦克风选择器在设备断开时保留最后选择，显示断开提示，并暂时回退到系统默认麦克风，直到设备重新连接。
- **声音**：在触发检测和发送时发出提示音；默认使用 macOS “玻璃”系统声音。您可以为每个事件选择任何 `NSSound` 可加载文件（例如 MP3/WAV/AIFF），或选择 **无声音**。

## 转发行为

- 当启用语音唤醒时，转录内容将转发到当前网关/代理（与 macOS 应用其余部分使用的相同本地 vs 远程模式）。
- 回复将发送到 **最后使用的主提供商**（WhatsApp/Telegram/Discord/WebChat）。如果发送失败，错误将记录，并且通过 WebChat/会话日志仍可见。

## 转发内容

- `VoiceWakeForwarder.prefixedTranscript(_:)` 在发送前添加机器提示。在唤醒词和按住说话路径之间共享。

## 快速验证

- 启用按住说话，按住 Cmd+Fn，说话，释放：覆盖层应显示部分文本然后发送。
- 按住时，菜单栏耳朵应保持放大（使用 `triggerVoiceEars(ttl:nil)`）；释放后耳朵会缩小。