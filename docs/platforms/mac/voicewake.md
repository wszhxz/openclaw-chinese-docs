---
summary: "Voice wake and push-to-talk modes plus routing details in the mac app"
read_when:
  - Working on voice wake or PTT pathways
title: "Voice Wake"
---
# 语音唤醒与按键通话

## 模式

- **唤醒词模式**（默认）：常开的语音识别器等待触发令牌（`swabbleTriggerWords`）。匹配时开始捕获，显示带有部分文本的叠加层，并在静音后自动发送。
- **按键通话（按住右Option键）**：按住右Option键立即开始捕获——无需触发。按住期间显示叠加层；释放后经过短暂延迟完成并转发，以便您可以调整文本。

## 运行时行为（唤醒词）

- 语音识别器位于 `VoiceWakeRuntime` 中。
- 仅当唤醒词和下一个词之间有**有意义的停顿**时才会触发（约0.55秒间隔）。叠加层/提示音可以在停顿时就开始，甚至在命令开始之前。
- 静音窗口：语音流畅时为2.0秒，仅听到触发词时为5.0秒。
- 硬停止：120秒以防止失控会话。
- 会话间防抖：350毫秒。
- 叠加层通过 `VoiceWakeOverlayController` 驱动，具有已提交/易失性着色。
- 发送后，识别器干净地重新启动以监听下一个触发。

## 生命周期不变量

- 如果启用了语音唤醒并且权限已授予，唤醒词识别器应该在监听（除非正在进行明确的按键通话捕获）。
- 叠加层可见性（包括通过X按钮手动关闭）绝不能阻止识别器恢复。

## 粘滞叠加层故障模式（以前）

以前，如果叠加层卡住可见状态并且您手动关闭它，语音唤醒可能看起来"死掉"，因为运行时的重启尝试可能被叠加层可见性阻止，且没有安排后续重启。

强化：

- 唤醒运行时重启不再被叠加层可见性阻止。
- 叠加层关闭完成通过 `VoiceSessionCoordinator` 触发 `VoiceWakeRuntime.refresh(...)`，因此手动X关闭总是恢复监听。

## 按键通话具体实现

- 热键检测使用全局 `.flagsChanged` 监控器用于**右Option**（`keyCode 61` + `.option`）。我们只观察事件（不吞咽）。
- 捕获管道位于 `VoicePushToTalk` 中：立即启动语音，将部分结果流式传输到叠加层，并在释放时调用 `VoiceWakeForwarder`。
- 当按键通话开始时，我们暂停唤醒词运行时以避免音频争用；释放后自动重启。
- 权限：需要麦克风+语音；查看事件需要辅助功能/输入监控批准。
- 外部键盘：某些可能不会按预期暴露右Option——如果用户报告遗漏，请提供备用快捷方式。

## 面向用户的设置

- **语音唤醒**切换：启用唤醒词运行时。
- **按住Cmd+Fn通话**：启用按键通话监控器。在macOS < 26上禁用。
- 语言和麦克风选择器、实时电平表、触发词表、测试器（仅本地；不转发）。
- 麦克风选择器在设备断开连接时保留上次选择，显示断开连接提示，并临时回退到系统默认值直到设备返回。
- **声音**：触发检测和发送时发出提示音；默认为macOS"玻璃"系统声音。您可以为每个事件选择任何 `NSSound` 可加载文件（如MP3/WAV/AIFF）或选择**无声音**。

## 转发行为

- 启用语音唤醒时，转录文本转发到活动网关/代理（与mac应用其余部分使用的本地vs远程模式相同）。
- 回复发送到**最后使用的主提供商**（WhatsApp/Telegram/Discord/WebChat）。如果发送失败，错误会被记录，运行仍可通过WebChat/会话日志查看。

## 转发负载

- `VoiceWakeForwarder.prefixedTranscript(_:)` 在发送前预置机器提示。在唤醒词和按键通话路径之间共享。

## 快速验证

- 打开按键通话，按住Cmd+Fn，说话，释放：叠加层应显示部分结果然后发送。
- 按住期间，菜单栏耳朵应保持放大状态（使用 `triggerVoiceEars(ttl:nil)`）；释放后缩小。